var NRF_Mapaddress_Widget=function(){function e(){this.controller=null,this.init()}var t=e.prototype;return t.init=function(){var t=this;this.getInstances().forEach(function(e){t.determineFieldValidityAndToggleValidatorField(e)}),document.addEventListener("change",function(e){this.onCoordinatesChange(e)}.bind(this)),document.addEventListener("click",function(e){this.onHideAutocompleteResults(e),this.onSelectAutocompleteItem(e),this.onClearMap(e)}.bind(this)),document.addEventListener("keyup",this.debounce(function(e){t.onAddressAutocomplete(e),t.onTypeData(e)},500)),document.querySelectorAll("joomla-field-subform").forEach(function(e){e.addEventListener("subform-row-add",function(e){t.render(e)})})},t.getInstances=function(){return document.querySelectorAll(".nrf-widget.tf-mapaddress-editor")},t.debounce=function(r,s){var d;return function(){var e=this,t=arguments;clearTimeout(d),d=setTimeout(function(){return r.apply(e,t)},s)}},t.onTypeData=function(e){var t=e.target.closest(".nrf-widget.tf-mapaddress-editor");t&&this.determineFieldValidityAndToggleValidatorField(t)},t.onHideAutocompleteResults=function(e){var t=this;e.target.closest(".tf-mapaddress-field-autocomplete-results")||document.querySelectorAll(".tf-mapaddress-field-autocomplete-results.is-visible").forEach(function(e){t.hideAutocompleteResult(e)})},t.hideAutocompleteResult=function(e){e.classList.remove("is-visible"),e.innerHTML=""},t.onAddressAutocomplete=function(e){var t=e.target.closest('.tf-mapaddress-field-address[data-autocomplete="true"]');if(t){this.controller&&this.controller.abort(),this.controller=new AbortController;var r=this.controller.signal,s=t.nextElementSibling,d=this,i=t.value.split(" ").map(function(e){return encodeURIComponent(e)}).join("+").trim();if(""!==i)fetch("https://nominatim.openstreetmap.org/search?q="+i+"&format=geojson",{signal:r}).then(function(e){return e.json()}).then(function(e){d.showResults(e,s)});else this.hideResults(s)}},t.onClearMap=function(e){var t=e.target.closest(".tf-mapaddress-editor-clear");if(t){e.preventDefault();var r=t.closest(".nrf-widget.tf-mapaddress-editor"),s=r.querySelector(".nr_address_coords");s&&(s.value="",s.dispatchEvent(new CustomEvent("change",{bubbles:!0}))),this.clearAddressDetails(r),t.parentElement.classList.add("clear-is-hidden"),this.determineFieldValidityAndToggleValidatorField(container)}},t.onSelectAutocompleteItem=function(e){var t=e.target.closest(".tf-mapaddress-field-autocomplete-item");if(t){var r=t.closest(".nrf-widget.tf-mapaddress-editor"),s=t.dataset.coordinates.split(","),d=r.querySelector(".nrf-widget.openstreetmap");d?(s=ol.proj.transform([s[1],s[0]],"EPSG:4326","EPSG:3857"),d.OpenStreetMap.updateMapCoordinates(s)):(this.getAddressDetails(s[0],s[1],r,this.afterCoordinatesChange.bind(this)),r.querySelector(".tf-mapaddress-map-wrapper").classList.remove("clear-is-hidden")),this.hideAutocompleteResult(t.parentElement),this.determineFieldValidityAndToggleValidatorField(r)}},t.showResults=function(e,r){r.innerHTML="",e.features.length?(e.features.forEach(function(e){var t='<div class="tf-mapaddress-field-autocomplete-item" data-coordinates="{coordinates}">{label}</div>';t=(t=t.replace("{coordinates}",e.geometry.coordinates[1]+","+e.geometry.coordinates[0])).replace("{label}",e.properties.display_name),r.innerHTML+=t}),r.classList.add("is-visible")):this.hideResults(r)},t.hideResults=function(e){e.classList.remove("is-visible")},t.render=function(e){var t=e.target.querySelectorAll(".nrf-widget.tf-mapaddress-editor .nrf-widget.openstreetmap:not(.done)");t&&t.forEach(function(e){new NR_OSM_Map(e).render(),e.classList.add("done")})},t.onCoordinatesChange=function(e){var t=e.target.closest(".nr_address_coords");if(t){var r=t.value.split(",");if(1!==r.length){var s=t.closest(".nrf-widget.tf-mapaddress-editor");s.querySelector(".tf-mapaddress-map-wrapper").classList.remove("clear-is-hidden");var d=r[0].trim(),i=r[1].trim();this.getAddressDetails(d,i,s,this.afterCoordinatesChange.bind(this)),this.determineFieldValidityAndToggleValidatorField(s)}}},t.afterCoordinatesChange=function(e,t){this.clearAddressDetails(t),this.updateAddressDetails(t,e)},t.getAddressDetails=function(e,t,r,s){fetch("https://nominatim.openstreetmap.org/reverse?lat="+e+"&lon="+t+"&format=json").then(function(e){return e.json()}).then(function(e){s(e,r)})},t.clearAddressDetails=function(t){this.getFields().forEach(function(e){t.querySelector(".tf-mapaddress-field-"+e).value=""})},t.updateAddressDetails=function(e,t){t.error||t.address&&(e.querySelector(".tf-mapaddress-field-latitude").value=t.lat,e.querySelector(".tf-mapaddress-field-longitude").value=t.lon,e.querySelector(".tf-mapaddress-field-address").value=t.display_name,t.address.country&&(e.querySelector(".tf-mapaddress-field-country").value=t.address.country),t.address.country_code&&(e.querySelector(".tf-mapaddress-field-country_code").value=t.address.country_code),t.address.city&&(e.querySelector(".tf-mapaddress-field-city").value=t.address.city),t.address.postcode&&(e.querySelector(".tf-mapaddress-field-postal_code").value=t.address.postcode),t.address.county&&(e.querySelector(".tf-mapaddress-field-county").value=t.address.county),t.address.state&&(e.querySelector(".tf-mapaddress-field-state").value=t.address.state),t.address.municipality&&(e.querySelector(".tf-mapaddress-field-municipality").value=t.address.municipality),t.address.town&&(e.querySelector(".tf-mapaddress-field-town").value=t.address.town),t.address.road&&(e.querySelector(".tf-mapaddress-field-road").value=t.address.road))},t.determineFieldValidityAndToggleValidatorField=function(e){if(this.isRequired(e)){var t=this.isValid(e)?"hide":"show",r=e.querySelector(':scope > input[type="hidden"]');if("hide"==t)return r.removeAttribute("required"),void r.classList.remove("required");r.setAttribute("required","required"),r.classList.add("required")}},t.isValid=function(r){var s=!0;return this.getFields().forEach(function(e){var t=r.querySelector(".control-group."+e+".is-visible .tf-mapaddress-field-"+e);t&&""===t.value.trim()&&(s=!1)}),s},t.isRequired=function(e){return!!e.querySelector(':scope > input[type="hidden"]')},t.getFields=function(){return["address","latitude","longitude","country","country_code","city","county","postal_code","state","municipality","town","road"]},e}();document.addEventListener("DOMContentLoaded",function(){new NRF_Mapaddress_Widget});

